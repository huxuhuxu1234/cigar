<?php require_once 'util.php';require_once 'salt.php';require_once 'source/class/class_core.php';global $_G;// decode id first.$code = '';if (isset($_GET['id'])){    $code = $_GET['id'];}$id = $salt->decode($code);if ($id == -1){    header('Location: culture.php');    exit();}//热门阅读$hot_data = C::t('cigar_culture')->hot_read_content();//文章数据$data = C::t('cigar_culture')->fetch($id);//是否点赞了,用户评分$up_class = 'four_line_left';$up_class_state = 0;$point_script = '';$pointed_script = '';$uid = $_G['uid'];if ($uid != 0){    //登录的用户    $up_data = C::t('cigar_culture_evaluates')->evaluate_data($uid,$id);    if ($up_data){        if ($up_data['is_up'] == 1){            $up_class = 'four_line_left_active';            $up_class_state = 1;        }        if ($up_data['point'] != 0){//             $point_script = '$(\'.star1[rel='.$up_data['point']."]').click();";			$pointed_script = 'pointed=true;';            $point_script = <<<EOTvar num = {$up_data['point']};$(".star1,.star1show").each(function() {	if (parseInt($(this).attr("rel")) <= num) {		$(this).attr("class", "star1show");	} else {		$(this).attr("class", "star1");	}});$('.star-content').html('{$up_data['point']}分');EOT;        }    }}//总共多少次评分， 平均分为$e_count = 0;$e_avg = 0;$e_data = C::t('cigar_culture_evaluates')->evaluate_count_and_avg($id);if ($e_data){    $e_count = $e_data['count'];    $e_avg = $e_data['point'];}//上一篇， 下一篇$next_url = '';$prev_url = '';//上一个id$p_id = C::t('cigar_culture')->_prev_id($id);//下一个id$n_id = C::t('cigar_culture')->_next_id($id);if ($p_id == -1){    // 没有上一个    $prev_url = '<a href="culture.php"><div class="last_line_top">返回列表</div></a>';}else{   $prev_url = '<a href="?id='.$salt->encode(3,$p_id).'"><div class="last_line_top">上一篇：'.C::t('cigar_culture')->fetch($p_id)['title'].'</div></a>' ;}if ($n_id == -1){    // 没有下一个    $next_url = '<a href="culture.php"><div class="last_line_bottom">返回列表</div></a>';}else{    $next_url = '<a href="?id='.$salt->encode(3,$n_id).'"><div class="last_line_bottom">下一篇：'.C::t('cigar_culture')->fetch($n_id)['title'].'</div></a>';}//广告$ad = C::t('cigar_culture_ad')->ad(3);?><!DOCTYPE html><html>	<head>		<meta charset="utf-8" />		<title><?php echo $data['title'];?> - 雪茄文化 - <?php echo $_MCONFIG['title'];?></title>		<?php echo_web_keywords_and_descr();?>		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>		<link rel="stylesheet" type="text/css" href="css/top.css"/>		<link rel="stylesheet" type="text/css" href="css/wenzhangxiangqing.css"/>		<link rel="stylesheet" type="text/css" href="css/foot.css"/>				<script type="text/javascript" src="js/jquery-1.9.1.min.js" ></script>				<!-------星星打分JS----------------->		<script>			var pointed = false;			<?php echo $pointed_script; ?>			$(document).ready(function(){								$(".star1,.star1show").mouseover(function() {										if(pointed){						return ;					}					var flag = $(this).parent().parent().attr("states");					if (flag==1) {						var num = parseInt($(this).attr("rel"));						$(".star1,.star1show").each(function() {							if (parseInt($(this).attr("rel")) <= num) {								$(this).attr("class", "star1show")							} else {								$(this).attr("class", "star1")							}						});					} else {					}				});							$(".star1,.star1show").click(function() {					//判断是否登录					if($('.denglu').length == 1){						if($('.denglu').html() == '登录'){							alert('请先登录');							return false;						}					}										//评分					var num = parseInt($(this).attr("rel"));										//获取文章id					var id = location.search.substring(4);					var clickd = $(this);										$.post('action.php?action=cul_ev',{'id': id,'point': num},function(data){//						alert(data.errorCode);						switch(data.errorCode){							case '0':								// 评分成功								//应该出分数								{									$('#high-star').attr("value",num);									clickd.parent().parent().attr("states","2");									$(".star1,.star1show").each(function() {										var item = $(this);																			if (parseInt(item.attr("rel")) <= num) {											item.attr("class", "star1show");										} else {											item.attr("class", "star1");										}									});									var string1 = clickd.attr("title");									$('.star-content').html(string1);																		//修改平均分									$.post('action.php?action=cul_ev_p_and_n',{id: id},function(data){										if(data.hasOwnProperty('errorCode')){											return;										}										$('#ev_point').html(data.point);										$('#ev_num').html(data.count);									},'json');																		pointed = true;								}								break;							case '1':								alert('请先登录');								break;							case '2':							case '3':							case '4':								alert('参数有误，请刷新后重试');								break;						}					},'json').error(function(XMLHttpRequest, textStatus, errorThrown){//						alert(XMLHttpRequest.responseText);						alert('发生了一个未知的错误，请联系管理员');					});				});								$(".star1,.star1show").mouseout(function(){					if(pointed){						return ;					}									$(".starshow").each(function(){						$(this).attr("class","star1");					});					var num = $("#high-star").attr("value");					$(".star1,.star1show").each(function() {						if (parseInt($(this).attr("rel")) <= num) {							$(this).attr("class", "star1show");						} else {							$(this).attr("class", "star1");						}					});				});												<?php echo $point_script;?>			});					</script>				<!---------点赞按钮JS-------------->		<script>			$(function(){				$(".banner_bag_main .All_part .left_part .four_line .four_line_left").click(function(){						//点赞						var id = location.search.substring(4);						var flag = $(this).attr("state");						var event_object = $(this);						if (flag == 0){							$.post('action.php?action=cul_up',{'id': id,'op': '1'},function(data){																if(data.hasOwnProperty('errorCode')){									switch(data.errorCode){										case '1':											alert('请先登录');											return;										case '2':										case '3':										case '4':											alert('参数有误，请刷新后重试');											return;									}								}								var num = parseInt(event_object.html());								event_object.html(num + 1);								event_object.attr("state","1");								event_object.attr("class","four_line_left_active");							},'json').error(function(XMLHttpRequest, textStatus, errorThrown){//								alert(XMLHttpRequest.responseText);								alert('发生了一个未知的错误，请联系管理员');							});													}else{							$.post('action.php?action=cul_up',{'id': id,'op': '0'},function(data){																if(data.hasOwnProperty('errorCode')){									switch(data.errorCode){										case '1':											alert('请先登录');											return;										case '2':										case '3':										case '4':											alert('参数有误，请刷新后重试');											return;									}								}								var num = parseInt(event_object.html());								event_object.html(num - 1);								event_object.attr("state","0");								event_object.attr("class","four_line_left");							},'json').error(function(XMLHttpRequest, textStatus, errorThrown){//								alert(XMLHttpRequest.responseText);								alert('发生了一个未知的错误，请联系管理员');							});						}				});								$(".banner_bag_main .All_part .left_part .four_line .four_line_left_active").click(function(){					//取消点赞					var id = location.search.substring(4);					var flag = $(this).attr("state");					var event_object = $(this);					if(flag == 1){						$.post('action.php?action=cul_up',{'id': id,'op': '0'},function(data){																if(data.hasOwnProperty('errorCode')){									switch(data.errorCode){										case '1':											alert('请先登录');											break;										case '2':										case '3':										case '4':											alert('参数有误，请刷新后重试');											break;									}								}								var num = parseInt(event_object.html());								event_object.html(num - 1);								event_object.attr("state","0");								event_object.attr("class","four_line_left");							},'json').error(function(XMLHttpRequest, textStatus, errorThrown){//								alert(XMLHttpRequest.responseText);								alert('发生了一个未知的错误，请联系管理员');							});					}else{						$.post('action.php?action=cul_up',{'id': id,'op': '1'},function(data){																if(data.hasOwnProperty('errorCode')){									switch(data.errorCode){										case '1':											alert('请先登录');											break;										case '2':										case '3':										case '4':											alert('参数有误，请刷新后重试');											break;									}								}								var num = parseInt(event_object.html());								event_object.html(num + 1);								event_object.attr("state","1");								event_object.attr("class","four_line_left_active");							},'json').error(function(XMLHttpRequest, textStatus, errorThrown){//								alert(XMLHttpRequest.responseText);								alert('发生了一个未知的错误，请联系管理员');							});					}				});												// 分享				$('.s1').click(function(){										$('#sButtons div a:eq(0)').click();								});								$('.s2').click(function(){										$('#sButtons div a:eq(1)').click();								});								$('.s3').click(function(){										$('#sButtons div a:eq(2)').click();								});								$('.s4').click(function(){										$('#sButtons div a:eq(3)').click();								});			});		</script>			</head>	<body>				<?php echo_header();?>				<!------------------------主体部分--------------------->		<div class="banner_bag">			<div class="banner_bag_top">				<div class="banner_bag_top_list">					<a href="./" class="banner_bag_top_a">首页</a>&nbsp;>&nbsp;					<a href="culture.php" class="banner_bag_top_a">雪茄文化</a>&nbsp;>&nbsp;					<a href="#" class="banner_bag_top_a">烟草的概述</a>				</div>			</div>						<div class="banner_bag_main">				<div class="All_part">					<div class="left_part">						<div class="first_line">							<div class="first_line_content">							 <img alt="" src="<?php echo $data['image']?>" width="580px" height="270px" />							</div>						</div>												<div id="sButtons" style="display: none;">						<!-- JiaThis Button BEGIN -->						<div class="jiathis_style_32x32">							<a class="jiathis_button_email"></a>							<a class="jiathis_button_weixin"></a>							<a class="jiathis_button_tsina"></a>							<a class="jiathis_button_renren"></a>							<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>							<a class="jiathis_counter_style"></a>						</div>						<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>						<!-- JiaThis Button END -->						</div>						<div class="second_line">							<div class="second_line_content_img1 s1" ></div>							<div class="second_line_content_text s1" >邮件</div>							<div class="second_line_content_img2 s2" ></div>							<div class="second_line_content_text s2" >微信</div>							<div class="second_line_content_img3 s3" ></div>							<div class="second_line_content_text s3" >微博</div>							<div class="second_line_content_img4 s4" ></div>							<div class="second_line_content_text s4" >人人</div>							<div class="second_line_content_text2">订阅到烟草414</div>							<div class="second_line_content10"></div>							<a href="http://www.cigarcn.com/subs.php?id=<?php echo $id;?>" target="_blank" ><div class="second_line_content11"></div></a>						</div>												<div class="third_line">							<div class="third_line_title">								<?php echo $data['title'];?>							</div>							<div class="third_line_admin">								来源：<?php echo $data['source'];?>							</div>							<div class="third_line_content">								<?php echo $data['content'];?>							</div>						</div>												<div class="four_line">							<div class="<?php echo $up_class;?>" state = "<?php echo $up_class_state;?>"><?php echo $data['up_count'];?></div>							<div class="four_line_right">								<div class="four_line_right_top">对本文进行打分：</div>								<div class="four_line_right_middle" states = "1">									<div class="star">										<div class="star1" rel="1" title="1分"></div>										<div class="num">1</div>									</div>									<div class="star">										<div class="star1" rel="2" title="2分"></div>										<div class="num">2</div>									</div>									<div class="star">										<div class="star1" rel="3" title="3分"></div>										<div class="num">3</div>									</div>									<div class="star">										<div class="star1" rel="4" title="4分"></div>										<div class="num">4</div>									</div>									<div class="star">										<div class="star1" rel="5" title="5分"></div>										<div class="num">5</div>									</div>									<div class="star-content" ></div>									<input type="hidden" value="" id="high-star">								</div>								<div class="four_line_right_bottom">									当前平均分：<div style="color: #eb6100;display: inline;" id="ev_point"><?php echo $e_avg;?></div>（<span id="ev_num" style="color: #6a3906"><?php echo $e_count;?></span>次打分）																</div>							</div>						</div>											<div class="last_line">						  <?php echo $prev_url;?>						  <?php echo $next_url;?>						</div>					</div>										<div class="right_part_1">						<div class="first_line">							热门阅读						</div>						<!------下划线------------>						<div class="second_line">													</div>												<?php  												//输出热门阅读						foreach ($hot_data as $row){						    $code = $salt->encode(3,$row['cid']); ?>						    <div class="third_line">	<div class="third_line_top">		<img src="<?php echo $row['image'] ?>" width="260px" height="90px"/>	</div>	<a href="?id=<?php echo $code ?>">	<div class="third_line_content">		<div style="color: #6a3906;font-weight: bold;font-size: 14px;margin-bottom: 12px;"><?php echo $row['title'] ?></div>		<div class="hot_read_font">			<?php echo sub_str($row['description'],60) ?>		</div>	</div>	</a>        <a href="?id=<?php echo $code ?>">	<div class="third_line_bottom">		阅读更多	</div>    </a></div>    <?php 						    						}																		?>											</div>										<div class="right_part_2">						<div class="right_part_2_content">						<?php 					   if ($ad){					       //980*80					       echo <<<EOT<a href="{$ad['url']}" ><img src="{$ad['image']}" width="260px" height="260px" /></a>EOT;					   }else{					       echo '广告招租位';					   }										?>						</div>					</div>				</div>			</div>		</div>						<?php echo_footer();?>	</body></html>